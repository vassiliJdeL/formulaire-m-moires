<!-- Widget Uploadcare (inchangé) -->
<script>
  // Clé publique Uploadcare (globale)
  UPLOADCARE_PUBLIC_KEY = "21d7228fa1f01ac80183";
</script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

<script>
  const form = document.querySelector('form');
  const widget = uploadcare.Widget('[role=uploadcare-uploader]');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // 1) Récupération de la valeur du widget
    const fileValue = widget.value();
    if (!fileValue) {
      alert("Merci d’ajouter un fichier .docx avant d’envoyer.");
      return;
    }

    try {
      // 2) Attendre la fin de l’upload (obligatoire)
      const fileInfo = await fileValue.promise(); // { cdnUrl, name, ... }

      if (!fileInfo || !fileInfo.cdnUrl) {
        alert("Erreur Uploadcare : URL du fichier introuvable.");
        return;
      }

      // 3) Construire la charge utile du formulaire
      const fd = new FormData(form);

      // On envoie explicitement une URL pour le backend
      // Choix 1: le champ traditionnel 'url' (recommandé pour ton nœud HTTP)
      fd.set('url', fileInfo.cdnUrl);

      // (optionnel) garder l’info d’origine utile pour logs
      fd.set('fileUrl', fileInfo.cdnUrl);
      fd.set('filename', fileInfo.name || 'memoire.docx');

      // Évite toute confusion côté backend
      fd.delete('file');

      // 4) POST vers ton webhook n8n
      const resp = await fetch(form.action, { method: 'POST', body: fd });

      if (resp.ok) {
        form.style.display = 'none';
        document.getElementById('confirmation').style.display = 'block';
      } else {
        const t = await resp.text().catch(() => "");
        alert("Erreur lors de la soumission. Détail: " + (t || resp.status));
      }
    } catch (err) {
      console.error(err);
      alert("Erreur de connexion / upload. Réessaie.");
    }
  });
</script>
