<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Bienvenue dans l’espace évaluation du mémoire / Welcome to the thesis assessment area</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#666;--border:#d5d7de;--shadow:0 6px 30px rgba(0,0,0,.08)}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;color:var(--text)}
    .wrap{max-width:860px;margin:40px auto;padding:24px 28px;background:var(--card);border-radius:14px;box-shadow:var(--shadow)}
    h1{font-size:28px;margin:0 0 6px}
    .sub{color:var(--muted);margin:0 0 22px}
    form{display:grid;grid-template-columns:1fr 1fr;gap:14px 16px}
    label{font-weight:600;font-size:14px}
    input[type=text],input[type=email],select{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:14px
    }
    .full{grid-column:1 / -1}
    .row{display:flex;align-items:flex-start;gap:10px}
    .pill{display:inline-block;background:#fde9c6;border:1px solid #f2c27b;padding:8px 10px;border-radius:999px;font-size:12.5px}
    .consent{font-size:10px;line-height:1.4;color:#333}
    button{background:#111827;color:#fff;border:0;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .confirm{display:none;margin-top:18px;padding:16px;border:1px solid #cfe7cf;background:#eef9ee;border-radius:10px}
    .error{color:#b40000;margin-top:8px}
    .hint{font-size:12px;color:#666}
  </style>

  <!-- Uploadcare v3 (widget) -->
  <script>
    window.UPLOADCARE_LOCALE = 'fr';
    window.UPLOADCARE_TABS = 'file url';
    window.UPLOADCARE_CLEARABLE = true;
  </script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Bienvenue dans l’espace évaluation du mémoire / Welcome to the thesis assessment area</h1>
    <p class="sub">Merci de compléter soigneusement tous les champs ci-dessous. / Please fill in all fields carefully.</p>

    <!-- IMPORTANT : URL = webhook PRODUCTION n8n -->
    <form id="memoire-form"
          action="https://vassili-jdel.app.n8n.cloud/webhook/auto-eval-memoire"
          method="post"
          enctype="multipart/form-data"
          novalidate>
      <div>
        <label for="prenom">Prénom / Forename *</label>
        <input type="text" id="prenom" name="prenom" required>
      </div>
      <div>
        <label for="nom">Nom / Surname *</label>
        <input type="text" id="nom" name="nom" required>
      </div>

      <div class="full">
        <label for="email">Email *</label>
        <input type="email" id="email" name="email" required>
      </div>

      <div>
        <label for="titre">Titre du mémoire *</label>
        <input type="text" id="titre" name="titre" required>
      </div>
      <div>
        <label for="title">Thesis title *</label>
        <input type="text" id="title" name="title" required>
      </div>

      <div class="full row" style="align-items:center">
        <label for="langue" style="min-width:180px">Langue / Language *</label>
        <select id="langue" name="langue" required>
          <option value="">—</option>
          <option value="français">Français / French</option>
          <option value="anglais">Anglais / English</option>
        </select>
      </div>

      <!-- Uploadcare (DOCX uniquement) -->
      <div class="full">
        <label for="uc-file">Fichier .docx / .docx file *</label>
        <input
          type="hidden"
          role="uploadcare-uploader"
          id="uc-file"
          name="file"
          data-public-key="21d7228fa1f01ac80183"
          data-clearable
          data-images-only="false"
          data-file-types=".docx"
          data-multiple="false"
          data-input-accept-types=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
        />
        <div class="pill">10&nbsp;MB max — 30 000 mots maximum / 30,000 words max</div>
        <div id="upload-error" class="error" style="display:none"></div>
      </div>

      <!-- Consentement RGPD -->
      <div class="full">
        <label class="row">
          <input type="checkbox" name="rgpd" required style="margin-top:4px">
          <span class="consent">
            <strong>FR :</strong> Les données collectées via ce formulaire sont utilisées pour l’évaluation du mémoire de fin d’études.
            Le fichier téléversé n’est pas stocké et est supprimé automatiquement à la fin de l’évaluation. Contact : <em>vassili.joannides.de.lautour@gmail.com</em>.<br><br>
            <strong>EN (UK):</strong> Data collected through this form is used solely to assess your thesis. The uploaded file is not stored and is automatically deleted after the assessment.
          </span>
        </label>
      </div>

      <div class="full">
        <button type="submit" id="submit-btn">Soumettre / Submit</button>
        <div class="hint" aria-live="polite" id="live-hint"></div>
      </div>
    </form>

    <div id="confirmation" class="confirm" role="status" aria-live="polite">
      <strong>✅ Soumission reçue.</strong><br>
      L’évaluation est en cours. Tu la recevras par email si tout se passe bien.
    </div>
  </div>

  <script>
    // Sécurité Uploadcare : pas limité aux images
    try { uploadcare.settings.imagesOnly = false; } catch(e) {}

    const PROD_WEBHOOK = 'https://vassili-jdel.app.n8n.cloud/webhook/auto-eval-memoire';

    const form   = document.getElementById('memoire-form');
    const widget = uploadcare.Widget('#uc-file');
    const errBox = document.getElementById('upload-error');
    const hintEl = document.getElementById('live-hint');
    const btn    = document.getElementById('submit-btn');

    // Auth désactivée à court terme
    const USE_HEADER_AUTH = false;
    const HEADER_NAME  = 'WebhookSubmitToken';
    const HEADER_VALUE = '2_TOUGH_eval_5_on';

    function say(msg){ if(hintEl){ hintEl.textContent = msg; } }

    // Forcer l'action sur l'URL de production & bloquer toute URL de test
    form.setAttribute('action', PROD_WEBHOOK);
    if (form.action.includes('/webhook-test/')) {
      alert('Configuration invalide : URL de TEST détectée. Merci de corriger l’URL du webhook.');
      throw new Error('Webhook test URL detected');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errBox.style.display = 'none';
      errBox.textContent = '';
      say('');

      const v = widget.value();
      if (!v) {
        errBox.textContent = "Merci d’ajouter un fichier .docx avant d’envoyer.";
        errBox.style.display = 'block';
        return;
      }

      btn.disabled = true;
      say('Téléversement en cours… / Uploading…');

      try {
        const info = await v.promise(); // { cdnUrl, name, mimeType, size, ... }

        // Garde-fous locaux
        const isDocx = info.mimeType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                    || /\.docx$/i.test(info.name || '');
        if (!isDocx) {
          btn.disabled = false; say('');
          errBox.textContent = "Seuls les fichiers .docx sont autorisés.";
          errBox.style.display='block';
          return;
        }
        if (info.size && info.size > 10 * 1024 * 1024) {
          btn.disabled = false; say('');
          errBox.textContent = "Fichier trop volumineux (>10 MB).";
          errBox.style.display='block';
          return;
        }

        // Payload : on envoie l'URL Uploadcare + métadonnées
        const fd = new FormData(form);
        fd.delete('file'); // ne pas envoyer la valeur brute du widget
        fd.set('fileUrl', info.cdnUrl);
        fd.set('url', info.cdnUrl);           // alias utile côté n8n
        fd.set('filename', info.name || 'memoire.docx');
        fd.set('mime', info.mimeType || 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
        if (info.size) fd.set('size', String(info.size));

        say('Envoi au serveur… / Submitting…');

        const headers = {};
        if (USE_HEADER_AUTH) headers[HEADER_NAME] = HEADER_VALUE;

        const resp = await fetch(form.action, {
          method: 'POST',
          mode: 'cors',
          body: fd,
          headers
        });

        btn.disabled = false; say('');

        if (resp.ok) {
          form.style.display = 'none';
          document.getElementById('confirmation').style.display = 'block';
        } else {
          const t = await resp.text().catch(()=> '');
          errBox.textContent = (resp.status === 401 || resp.status === 403)
            ? "Erreur d’authentification (401/403). Vérifie la configuration du webhook n8n."
            : "Erreur de soumission (serveur) : " + (t || resp.status);
          errBox.style.display = 'block';
        }
      } catch (err) {
        console.error(err);
        btn.disabled = false; say('');
        errBox.textContent = "Erreur réseau / upload. Réessaie.";
        errBox.style.display = 'block';
      }
    });
  </script>
</body>
</html>
