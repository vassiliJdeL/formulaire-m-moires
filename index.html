<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Soumission de m√©moire / Thesis submission</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Uploadcare -->
  <script>
    // ‚úÖ Ta cl√© publique Uploadcare
    window.UPLOADCARE_PUBLIC_KEY = "21d7228fa1f01ac80183";
  </script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; line-height: 1.5; }
    form, #confirmation { max-width: 560px; }
    label { display: block; margin-top: 12px; }
    input, select, button { font-size: 16px; padding: 8px; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; margin-top: 16px; }
    .hint { font-size: 14px; color: #555; }
  </style>
</head>
<body>
  <h2>Soumission de m√©moire / Thesis submission</h2>

  <form id="memoireForm" autocomplete="on">
    <label for="prenom">Pr√©nom / First name:</label>
    <input type="text" id="prenom" name="prenom" required />

    <label for="nom">Nom / Last name:</label>
    <input type="text" id="nom" name="nom" required />

    <label for="titre">Titre du m√©moire / Thesis title:</label>
    <input type="text" id="titre" name="titre" required />

    <label for="email">Adresse email / Email address:</label>
    <input type="email" id="email" name="email" required />

    <label for="langue">Langue du m√©moire / Thesis language:</label>
    <select id="langue" name="langue" required>
      <option value="">-- Choisissez / Select --</option>
      <option value="fran√ßais">Fran√ßais / French</option>
      <option value="anglais">Anglais / English</option>
    </select>

    <label for="ucUploader">T√©l√©verser le fichier / Upload your file (.docx only):</label>
    <input
      type="hidden"
      id="ucUploader"
      role="uploadcare-uploader"
      name="file"
      data-file-types=".docx"
      data-clearable
    />
    <p class="hint">Format accept√©: .docx (Word). Attendez la fin du t√©l√©versement avant d'envoyer.</p>

    <label style="margin-top:16px;">
      <input type="checkbox" id="rgpd" required />
      J'accepte le traitement automatis√© de mes donn√©es dans le cadre de l'√©valuation de mon m√©moire.
    </label>

    <!-- ‚úÖ TOKEN c√¥t√© client (si tu veux le masquer, il faut passer par un backend) -->
    <input type="hidden" id="token" value="2_TOUGH_eval_5_on" />

    <button type="button" id="submitBtn">Soumettre / Submit</button>
  </form>

  <div id="confirmation" style="display:none; margin-top:20px;">
    <h2>üá´üá∑ M√©moire re√ßu avec succ√®s</h2>
    <p>Merci, ton m√©moire a bien √©t√© soumis.<br />
    ‚è≥ <strong>L‚Äô√©valuation est en cours de traitement.</strong><br />
    Tu la recevras par email dans les prochaines minutes, √† l‚Äôadresse que tu as indiqu√©e.<br />
    üì© <strong>Pense √† v√©rifier aussi tes courriers ind√©sirables</strong> (spams).</p>
    <hr />
    <h2>üá¨üáß Thesis successfully submitted</h2>
    <p>Thank you, your thesis has been successfully submitted.<br />
    ‚è≥ <strong>Your evaluation is being processed.</strong><br />
    You will receive it by email within the next few minutes.<br />
    üì© <strong>Check your spam folder</strong> just in case.</p>
  </div>

  <script>
    (function () {
      const WEBHOOK_URL = "https://vassili-jdel.app.n8n.cloud/webhook/auto-eval-memoire"; // ‚úÖ n8n Production URL
      const form = document.getElementById("memoireForm");
      const btn  = document.getElementById("submitBtn");
      const rgpd = document.getElementById("rgpd");

      const widget = uploadcare.Widget("#ucUploader");
      let lastFileInfo = null;

      // 1) Capture la fin d'upload Uploadcare
      widget.onUploadComplete(function (info) {
        lastFileInfo = info; // contient .cdnUrl, .name, .size, etc.
        console.log("Uploadcare file:", info);
      });

      async function submitToWebhook() {
        // a) validations basiques
        if (!rgpd.checked) {
          alert("Merci de cocher la case RGPD.");
          return;
        }
        if (!lastFileInfo || !lastFileInfo.cdnUrl) {
          alert("Veuillez t√©l√©verser votre fichier .docx (attendez la fin de l'upload).");
          return;
        }

        // b) construit un lien direct au binaire (Uploadcare)
        //    /-/raw/ renvoie le fichier brut, id√©al pour ton n≈ìud HTTP Extract DOCX
        const fileUrl = (lastFileInfo.cdnUrl.endsWith("/")) ? (lastFileInfo.cdnUrl + "-/raw/") : (lastFileInfo.cdnUrl + "/-/raw/");

        const payload = {
          token : document.getElementById("token").value,
          fileUrl,
          email : document.getElementById("email").value.trim(),
          langue: document.getElementById("langue").value,
          prenom: document.getElementById("prenom").value.trim(),
          titre : document.getElementById("titre").value.trim(),
          nom   : document.getElementById("nom").value.trim()
        };

        btn.disabled = true; btn.textContent = "Envoi‚Ä¶";

        try {
          const res = await fetch(WEBHOOK_URL, {
            method : "POST",
            headers: { "Content-Type": "application/json" },
            body   : JSON.stringify(payload)
          });

          const text = await res.text();
          console.log("Webhook:", res.status, text);

          if (res.status === 202) {
            form.style.display = "none";
            document.getElementById("confirmation").style.display = "block";
          } else if (res.status === 401) {
            alert("Acc√®s non autoris√© (token). V√©rifie la valeur du token.");
          } else {
            alert("Erreur c√¥t√© serveur (" + res.status + "). R√©essaie plus tard.");
          }
        } catch (e) {
          console.error(e);
          alert("Erreur r√©seau. R√©essaie plus tard.");
        } finally {
          btn.disabled = false; btn.textContent = "Soumettre / Submit";
        }
      }

      btn.addEventListener("click", submitToWebhook);
    })();
  </script>
</body>
</html>
