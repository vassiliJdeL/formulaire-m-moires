<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soumission du mémoire</title>
  <meta name="description" content="Dépose ton mémoire (.docx) pour évaluation automatisée." />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 720px; margin: 40px auto; padding: 0 16px; }
    h1 { margin-bottom: 6px; }
    p.lead { opacity:.8; margin-top:0 }
    label { display:block; margin-top:12px; font-weight:600; }
    input, select { width:100%; padding:10px; margin-top:6px; box-sizing:border-box; }
    button { margin-top:20px; padding:12px 16px; border:0; cursor:pointer; border-radius:8px; }
    .muted { font-size:14px; opacity:.7; }
    #confirmation { display:none; padding:16px; background:#f3f6ff; border-radius:8px; margin-top:24px; }
  </style>
</head>
<body>
  <h1>Soumission du mémoire</h1>
  <p class="lead">Dépose ton fichier .docx. Tu recevras une confirmation si tout se passe bien.</p>

  <form id="memoire-form"
        action="https://vassili-jdel.app.n8n.cloud/webhook/auto-eval-memoire"
        method="post" enctype="multipart/form-data">
    <label>Prénom
      <input name="prenom" required />
    </label>
    <label>Nom
      <input name="nom" required />
    </label>
    <label>Email
      <input type="email" name="email" required />
    </label>
    <label>Titre du mémoire
      <input name="titre" required />
    </label>
    <label>Langue
      <select name="langue" required>
        <option value="fr">Français</option>
        <option value="en">English</option>
      </select>
    </label>

    <!-- Uploadcare widget -->
    <label>Fichier (.docx)
      <input
        type="hidden"
        role="uploadcare-uploader"
        data-public-key="21d7228fa1f01ac80183"
        data-tabs="file url"
        data-clearable
        data-preferred-types=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
        name="file"
        required
      />
    </label>

    <label class="muted" style="font-weight:400">
      <input type="checkbox" name="rgpd" required />
      J’accepte le traitement de mes données pour l’évaluation de mon mémoire.
    </label>

    <button type="submit">Soumettre</button>
  </form>

  <div id="confirmation">
    <h2>Merci !</h2>
    <p>Ton mémoire a bien été envoyé. Tu recevras un message de confirmation sous peu.</p>
  </div>

  <noscript>Active JavaScript pour utiliser ce formulaire.</noscript>

  <!-- Uploadcare -->
  <script>
    UPLOADCARE_PUBLIC_KEY = "21d7228fa1f01ac80183";
  </script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

  <!-- Soumission vers n8n avec l’URL Uploadcare du fichier -->
  <script>
    const form = document.querySelector('#memoire-form');
    const widget = uploadcare.Widget('[role=uploadcare-uploader]');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fileValue = widget.value();
      if (!fileValue) {
        alert("Merci d’ajouter un fichier .docx avant d’envoyer.");
        return;
      }

      try {
        const fileInfo = await fileValue.promise(); // { uuid, name, cdnUrl, ... }
        if (!fileInfo || !fileInfo.uuid) {
          alert("Erreur Uploadcare : UUID du fichier introuvable.");
          return;
        }

        const uuid = fileInfo.uuid;
        const safeName = encodeURIComponent(fileInfo.name || 'memoire.docx');
        const publicUrl = `https://ucarecdn.com/${uuid}/${safeName}`;

        const fd = new FormData(form);
        fd.set('url', publicUrl);      // lu par n8n
        fd.set('fileUrl', publicUrl);  // pour logs
        fd.set('filename', fileInfo.name || 'memoire.docx');
        fd.delete('file'); // on n’envoie pas le binaire

        const resp = await fetch(form.action, { method: 'POST', body: fd });

        if (resp.ok) {
          form.style.display = 'none';
          document.getElementById('confirmation').style.display = 'block';
        } else {
          const t = await resp.text().catch(() => "");
          alert("Erreur lors de la soumission. Détail: " + (t || resp.status));
        }
      } catch (err) {
        console.error(err);
        alert("Erreur de connexion / upload. Réessaie.");
      }
    });
  </script>
</body>
</html>
