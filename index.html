<script>
  UPLOADCARE_PUBLIC_KEY = "21d7228fa1f01ac80183";
</script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

<script>
  const form = document.querySelector('form');
  const widget = uploadcare.Widget('[role=uploadcare-uploader]');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const fileValue = widget.value();
    if (!fileValue) {
      alert("Merci d’ajouter un fichier .docx avant d’envoyer.");
      return;
    }

    try {
      const fileInfo = await fileValue.promise(); // => { uuid, name, cdnUrl, ... }

      if (!fileInfo || !fileInfo.uuid) {
        alert("Erreur Uploadcare : UUID du fichier introuvable.");
        return;
      }

      // 👉 On force le domaine global correct du CDN :
      const uuid = fileInfo.uuid;
      const safeName = encodeURIComponent(fileInfo.name || 'memoire.docx');
      const publicUrl = `https://ucarecdn.com/${uuid}/${safeName}`;

      const fd = new FormData(form);
      fd.set('url', publicUrl);      // ← n8n lira ceci
      fd.set('fileUrl', publicUrl);  // pour logs
      fd.set('filename', fileInfo.name || 'memoire.docx');

      // Important : ne pas envoyer un champ "file" brut
      fd.delete('file');

      const resp = await fetch(form.action, { method: 'POST', body: fd });

      if (resp.ok) {
        form.style.display = 'none';
        document.getElementById('confirmation').style.display = 'block';
      } else {
        const t = await resp.text().catch(() => "");
        alert("Erreur lors de la soumission. Détail: " + (t || resp.status));
      }
    } catch (err) {
      console.error(err);
      alert("Erreur de connexion / upload. Réessaie.");
    }
  });
</script>
