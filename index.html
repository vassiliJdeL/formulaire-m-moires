<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Soumission de m√©moire / Thesis submission</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;padding:24px;max-width:760px;margin:auto}
    label{font-weight:600}
    input,select,button{font:inherit}
    .row{margin:10px 0}
    button{padding:10px 16px;border:1px solid #ccc;border-radius:6px;background:#111;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{color:#555;font-size:.9rem}
    .ok{display:none;margin-top:20px;border:1px solid #e0e0e0;padding:16px;border-radius:8px;background:#f8fff4}
  </style>
</head>
<body>
  <h2>Soumission de m√©moire / Thesis submission</h2>

  <!-- ‚ö†Ô∏è METS ICI L‚ÄôURL PRODUCTION DU WEBHOOK N8N -->
  <!-- Exemple: https://<ton-espace>.app.n8n.cloud/webhook/auto-eval-memoire -->
  <form id="mem-form" action="https://<TON_WEBHOOK_N8N>/webhook/auto-eval-memoire" method="post">
    <div class="row">
      <label for="prenom">Pr√©nom / First name *</label><br>
      <input id="prenom" name="prenom" type="text" required>
    </div>

    <div class="row">
      <label for="nom">Nom / Last name *</label><br>
      <input id="nom" name="nom" type="text" required>
    </div>

    <div class="row">
      <label for="email">Email *</label><br>
      <input id="email" name="email" type="email" required>
    </div>

    <div class="row">
      <label for="titre">Titre du m√©moire / Thesis title *</label><br>
      <input id="titre" name="titre" type="text" required>
    </div>

    <div class="row">
      <label for="langue">Langue / Language *</label><br>
      <select id="langue" name="langue" required>
        <option value="">-- Choisissez / Select --</option>
        <option value="fran√ßais">Fran√ßais / French</option>
        <option value="anglais">Anglais / English (NZ)</option>
      </select>
      <div class="hint">Si ‚Äúanglais‚Äù est choisi, la r√©ponse sera en anglais n√©o-z√©landais.</div>
    </div>

    <div class="row">
      <label>Fichier .docx / .docx file *</label><br>
      <!-- Uploadcare widget -->
      <input type="hidden"
             role="uploadcare-uploader"
             name="file"
             data-public-key="21d7228fa1f01ac80183"
             data-clearable
             data-multiple="false"
             data-file-types=".docx" />
      <div class="hint">Uniquement .docx ¬∑ Taille conseill√©e &lt; 20 Mo</div>
    </div>

    <!-- Jeton (pr√©-rempli via ?token=...) -->
    <input type="hidden" name="token" id="token" value="2_TOUGH_eval_5_on">

    <!-- Champ que NOUS remplissons avec l‚ÄôURL CDN finale du fichier -->
    <input type="hidden" name="url" id="fileUrl" required>
    <!-- Duplicata utile (logs) -->
    <input type="hidden" name="fileUrl" id="fileUrl2">
    <input type="hidden" name="filename" id="filename">

    <div class="row">
      <label><input type="checkbox" id="rgpd" required> J‚Äôaccepte le traitement aux fins d‚Äô√©valuation.</label>
    </div>

    <div class="row">
      <button id="submitBtn" type="submit">Soumettre / Submit</button>
    </div>
  </form>

  <div id="confirmation" class="ok">
    <h3>üá´üá∑ M√©moire re√ßu</h3>
    <p>Merci, ta soumission a bien √©t√© enregistr√©e.<br>‚è≥ L‚Äô√©valuation est en cours. Tu la recevras par email dans les prochaines minutes (v√©rifie tes spams).</p>
    <hr>
    <h3>üá¨üáß Thesis received</h3>
    <p>Thanks, your submission has been recorded.<br>‚è≥ Evaluation is in progress. You‚Äôll get it by email shortly (check spam).</p>
  </div>

  <!-- Uploadcare -->
  <script>UPLOADCARE_PUBLIC_KEY="21d7228fa1f01ac80183";</script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

  <script>
    // Pr√©-remplir le token via ?token=...
    (function(){
      const p = new URLSearchParams(location.search);
      const t = p.get('token');
      if (t) document.getElementById('token').value = t;
    })();

    const form = document.getElementById('mem-form');
    const submitBtn = document.getElementById('submitBtn');
    const widget = uploadcare.Widget('[role=uploadcare-uploader]');
    const fileUrlInput = document.getElementById('fileUrl');
    const fileUrl2Input = document.getElementById('fileUrl2');
    const filenameInput = document.getElementById('filename');

    // Quand l‚Äôupload est termin√©, on r√©cup√®re l‚ÄôURL CDN
    widget.onUploadComplete(function(info){
      if (info && info.cdnUrl) {
        fileUrlInput.value = info.cdnUrl;
        fileUrl2Input.value = info.cdnUrl;
        filenameInput.value = info.name || 'memoire.docx';
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // S√©curit√© : exiger l‚ÄôURL CDN finale
      if (!fileUrlInput.value) {
        alert("Le fichier n‚Äôest pas pr√™t. Attends la fin de l‚Äôupload (quelques secondes) puis r√©essaie.");
        return;
      }

      submitBtn.disabled = true;

      try {
        const fd = new FormData(form);
        // Nettoyage : on n‚Äôenvoie pas la r√©f√©rence interne "file" (Uploadcare)
        fd.delete('file');

        const resp = await fetch(form.action, { method: 'POST', body: fd });

        if (resp.ok) {
          form.style.display = 'none';
          document.getElementById('confirmation').style.display = 'block';
        } else {
          const t = await resp.text().catch(()=> "");
          alert("Erreur lors de la soumission. D√©tail: " + (t || resp.status));
        }
      } catch (err) {
        console.error(err);
        alert("Erreur r√©seau. Merci de r√©essayer.");
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>

  <noscript>Active JavaScript pour utiliser le formulaire.</noscript>
</body>
</html>
