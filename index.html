<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bienvenue dans l'espace évaluation du mémoire / Welcome to the thesis assessment area</title>
  <link rel="preconnect" href="https://ucarecdn.com" crossorigin>
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --brand:#0f172a;
      --ring:#2563eb; --border:#e5e7eb; --ok:#065f46; --err:#991b1b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    .wrap{max-width:880px;margin:48px auto;padding:0 18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px 28px 30px;
      box-shadow:0 8px 24px rgba(0,0,0,.06)}
    h1{margin:0 0 8px;font-size:26px;line-height:1.25;color:var(--brand)}
    .sub{margin:0 0 24px;color:var(--muted)}
    /* grille propre : labels + champs sur la même ligne */
    form{display:grid;gap:16px}
    .row{display:grid;grid-template-columns:260px 1fr;gap:14px;align-items:center}
    label{font-weight:600}
    input[type="text"],input[type="email"],select{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font:inherit;
      transition:border-color .15s, box-shadow .15s
    }
    input:focus,select:focus{outline:none;border-color:var(--ring);box-shadow:0 0 0 3px rgba(37,99,235,.18)}
    .hint{font-size:12.5px;color:var(--muted);margin-top:6px}
    .pill{display:inline-block;background:#f3f4f6;border:1px dashed #cbd5e1;border-radius:999px;padding:6px 10px;font-size:12.5px}
    .consent{font-size:10px;line-height:1.4;color:#4b5563}
    .actions{display:flex;gap:12px;align-items:center;margin-top:6px}
    button{appearance:none;border:0;border-radius:10px;padding:11px 16px;background:#111827;color:#fff;font-weight:700;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .msg{font-size:14px}
    .ok{color:var(--ok);display:none}
    .err{color:var(--err);display:none}
    @media (max-width:760px){ .row{grid-template-columns:1fr} }
  </style>

  <!-- Uploadcare -->
  <script>window.UPLOADCARE_PUBLIC_KEY="21d7228fa1f01ac80183";</script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js" defer></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Bienvenue dans l'espace d'évaluation du mémoire / Welcome to the thesis assessment area</h1>
      <p class="sub">Merci de compléter soigneusement tous les champs ci-dessous. / Please fill in all fields carefully.</p>

      <form id="memoireForm" action="https://vassili-jdel.app.n8n.cloud/webhook-test/auto-eval-memoire" method="post" novalidate>
        <div class="row">
          <label for="prenom">Prénom / Forename *</label>
          <input id="prenom" name="prenom" type="text" required autocomplete="given-name" />
        </div>

        <div class="row">
          <label for="nom">Nom / Name *</label>
          <input id="nom" name="nom" type="text" required autocomplete="family-name" />
        </div>

        <div class="row">
          <label for="email">Email *</label>
          <input id="email" name="email" type="email" required autocomplete="email" placeholder="name@example.com" />
        </div>

        <div class="row">
          <label for="titre">Titre du mémoire / Thesis title *</label>
          <input id="titre" name="titre" type="text" required />
        </div>

        <div class="row">
          <label for="langue">Langue / Language *</label>
          <select id="langue" name="langue" required>
            <option value="">—</option>
            <option value="français">Français / French</option>
            <option value="anglais">Anglais / English</option>
          </select>
        </div>

        <div class="row" style="align-items:start">
          <label>Fichier .doc ou .docx *</label>
          <div>
            <!-- IMPORTANT : pas de data-file-types ici → on laisse Uploadcare accepter, on filtrera nous-mêmes -->
            <input
              id="fdocx"
              type="hidden"
              role="uploadcare-uploader"
              name="file"
              data-public-key="21d7228fa1f01ac80183"
              data-system-dialog="true"
              data-multiple="false"
              data-clearable
              data-images-only="false"
            />
            <div class="hint"><span class="pill">30 000 mots maximum — 30,000 words maximum</span></div>
          </div>
        </div>

        <div class="row" style="align-items:flex-start">
          <label for="rgpd">RGPD / GDPR consent *</label>
          <div class="consent">
            <label style="display:flex;gap:10px;align-items:flex-start">
              <input type="checkbox" id="rgpd" name="rgpd" required />
              <span>
                <strong>FR :</strong> Les données collectées via ce formulaire sont utilisées pour l’évaluation du mémoire de fin d’études.
                Le fichier téléversé n’est pas stocké. Il est supprimé automatiquement à la fin de l’évaluation. Vous pouvez exercer vos droits d'accès,
                de rectification, de suppression, en nous contactant à
                <a href="mailto:vassili.joannides.de.lautour@gmail.com">vassili.joannides.de.lautour@gmail.com</a>.
                Ce formulaire est conforme au RGPD car il recueille votre consentement explicite via la case à cocher ci-contre.
                <br><br>
                <strong>EN (UK):</strong> The data collected through this form is used solely to assess your master’s thesis.
                The uploaded file is not stored and is automatically deleted at the end of the evaluation. You can exercise your rights of access,
                rectification and erasure by contacting
                <a href="mailto:vassili.joannides.de.lautour@gmail.com">vassili.joannides.de.lautour@gmail.com</a>.
                This form complies with the UK GDPR as it collects your explicit consent via the checkbox.
              </span>
            </label>
          </div>
        </div>

        <div class="actions">
          <button id="btn" type="submit">Soumettre / Submit</button>
          <span id="msg" class="msg"></span>
        </div>

        <!-- Jeton pour n8n -->
        <input type="hidden" name="token" value="2_TOUGH_eval_5_on" />
      </form>
    </div>

    <!-- Confirmation -->
    <div id="okBlock" class="ok" style="margin-top:16px">
      ✅ Mémoire reçu / Thesis received — l’évaluation sera envoyée par email sous peu.
    </div>
    <div id="errBlock" class="err" style="margin-top:16px"></div>
  </div>

  <script>
    // Helpers
    const $ = (s) => document.querySelector(s);
    const setMsg = (txt, ok=false) => {
      const el = $('#msg');
      el.textContent = txt || '';
      el.style.color = ok ? '#065f46' : '#991b1b';
    };
    const showOK = (txt) => { const b=$('#okBlock'); b.textContent = txt; b.style.display='block'; };
    const showERR = (txt) => { const b=$('#errBlock'); b.textContent = txt; b.style.display='block'; };

    // Contrôle strict côté client : extension .doc/.docx
    const isDocOrDocx = (name='') => /\.docx?$/i.test((name||'').trim());

    window.addEventListener('DOMContentLoaded', () => {
      const form = $('#memoireForm');
      const btn  = $('#btn');
      const widget = uploadcare.Widget('#fdocx'); // Uploadcare widget

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setMsg('');
        $('#okBlock').style.display = 'none';
        $('#errBlock').style.display = 'none';

        // Validation de base
        const required = ['#prenom','#nom','#email','#titre','#langue','#rgpd'];
        for (const sel of required) {
          const el = $(sel);
          if (!el || (el.type === 'checkbox' ? !el.checked : !el.value.trim())) {
            setMsg('Merci de compléter tous les champs obligatoires.', false);
            return;
          }
        }

        // Récupérer le fichier Uploadcare
        const value = widget.value();
        if (!value) { setMsg('Merci d’ajouter un fichier .doc ou .docx.', false); return; }

        btn.disabled = true;

        try {
          const info = await value.promise(); // { cdnUrl, name, mimeType, ... }

          // (diagnostic utile) — laisse le log activé le temps du test
          console.log('Uploadcare info:', { name: info?.name, mime: info?.mimeType, cdnUrl: info?.cdnUrl });

          if (!info || !info.cdnUrl) {
            setMsg("Erreur Uploadcare : URL du fichier introuvable.", false);
            btn.disabled = false; return;
          }

          if (!isDocOrDocx(info.name || '')) {
            setMsg("Seuls les fichiers .doc ou .docx sont acceptés.", false);
            btn.disabled = false; return;
          }

          // Construire la charge utile pour n8n
          const fd = new FormData(form);
          fd.set('url', info.cdnUrl);       // champ attendu par ton nœud HTTP
          fd.set('fileUrl', info.cdnUrl);   // pour logs
          fd.set('filename', info.name || 'memoire.docx');
          // Nettoyage : ne pas envoyer la ref interne du widget
          fd.delete('file');

          setMsg('Envoi en cours…', true);

          const resp = await fetch(form.action, { method: 'POST', body: fd });

          if (resp.ok) {
            form.reset();
            widget.value(null);
            setMsg('');
            showOK('✅ Mémoire reçu. L’évaluation arrive par email.');
          } else {
            const t = await resp.text().catch(()=> '');
            setMsg(`Erreur serveur (${resp.status}). ${t||''}`, false);
            showERR(`Erreur serveur (${resp.status}). ${t||''}`);
          }
        } catch (err) {
          console.error(err);
          setMsg("Erreur réseau / upload. Réessaie.", false);
          showERR("Erreur réseau / upload. Réessaie.");
        } finally {
          btn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
